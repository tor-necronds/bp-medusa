import{c as H,d as Q,e as F,f as G,g as K,h as W,i as J,j as X,k as Y,l as Z}from"./chunk-REUYEF7L-BCB7O_FO.js";import{a as O}from"./chunk-X6BAAGCL-Cmzs-01s.js";import{K as ee}from"./chunk-6HTZNHPT-DGQV_Lcz.js";import{b as R,u as te}from"./chunk-AERWK3TJ-DmmmqBU-.js";import{r as g,ah as se,b as M,u as ae,dd as ie,de as re,t as h,j as e,H as ne,dl as oe,aD as ce,aE as le,ax as V,dK as de,a5 as T,av as ue,J as f,K as $,aG as me,B as k,ay as fe,aI as xe,az as he,aK as L,dD as D}from"./index-DsV72Lgh.js";import{A as pe}from"./alert-DxcP6O8k.js";import"./chunk-DK4WIVY6-CYCbBMOO.js";var ye=Object.defineProperty,C=Object.getOwnPropertySymbols,P=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable,S=(a,i,r)=>i in a?ye(a,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[i]=r,ge=(a,i)=>{for(var r in i||(i={}))P.call(i,r)&&S(a,r,i[r]);if(C)for(var r of C(i))U.call(i,r)&&S(a,r,i[r]);return a},je=(a,i)=>{var r={};for(var n in a)P.call(a,n)&&i.indexOf(n)<0&&(r[n]=a[n]);if(a!=null&&C)for(var n of C(a))i.indexOf(n)<0&&U.call(a,n)&&(r[n]=a[n]);return r};const B=g.forwardRef((a,i)=>{var r=a,{color:n="currentColor"}=r,p=je(r,["color"]);return g.createElement("svg",ge({xmlns:"http://www.w3.org/2000/svg",width:15,height:15,fill:"none",ref:i},p),g.createElement("path",{stroke:n,strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M7.5 3.473 5.722 5.722 9.278 7.5 7.5 9.278"}),g.createElement("path",{stroke:n,strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M7.081 13.03a.9.9 0 0 0 .837 0c1.395-.727 5.803-3.366 5.803-7.655a3.42 3.42 0 0 0-3.4-3.43A3.45 3.45 0 0 0 7.5 3.472a3.45 3.45 0 0 0-2.82-1.529 3.42 3.42 0 0 0-3.401 3.43c0 4.29 4.407 6.929 5.802 7.657"}))});B.displayName="HeartBroken";var ve=V({items:xe(V({quantity:L().nullish(),dismissed_quantity:L().nullish(),item_id:he()})),send_notification:fe().optional()});function _e({form:a,item:i,index:r,returnId:n,orderId:p}){const{t:o}=M(),[b,w]=g.useState(!1),{mutateAsync:I}=X(n,p),{mutateAsync:q}=Y(n,p),{mutateAsync:_}=Z(n,p),[N,E]=g.useMemo(()=>{var y,t;const c=(y=i.actions)==null?void 0:y.find(s=>s.action==="RECEIVE_RETURN_ITEM"),d=(t=i.actions)==null?void 0:t.find(s=>s.action==="RECEIVE_DAMAGED_RETURN_ITEM");return[c==null?void 0:c.details.quantity,d==null?void 0:d.details.quantity]},[i]),x=async c=>{var y;const d=(y=i.actions)==null?void 0:y.find(t=>t.action==="RECEIVE_DAMAGED_RETURN_ITEM");if(typeof c=="number"&&c<0){a.setValue(`items.${r}.dismissed_quantity`,E,{shouldTouch:!0,shouldDirty:!0}),h.error(o("orders.returns.receive.toast.errorNegativeValue"));return}if(typeof c=="number"&&c>i.quantity-i.detail.return_received_quantity){a.setValue(`items.${r}.dismissed_quantity`,E,{shouldTouch:!0,shouldDirty:!0}),h.error(o("orders.returns.receive.toast.errorLargeDamagedValue"));return}try{c?d?await q({actionId:d.id,quantity:c}):await I({items:[{id:i.id,quantity:c}]}):d&&await _(d.id)}catch(t){h.error(t.message)}};return e.jsxs(D,{open:b,onOpenChange:w,children:[e.jsx(D.Trigger,{asChild:!0,children:e.jsxs(k,{className:"flex gap-2 px-2",variant:"secondary",type:"button",children:[e.jsx("div",{children:e.jsx(B,{})}),!!E&&e.jsx("span",{children:E})]})}),e.jsx(D.Content,{align:"center",children:e.jsxs("div",{className:"flex flex-col p-2",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle mb-2 font-medium",children:o("orders.returns.receive.writeOffInputLabel")}),e.jsx(f.Field,{control:a.control,name:`items.${r}.dismissed_quantity`,render:({field:{onChange:c,value:d,...y}})=>e.jsx(f.Item,{className:"w-full",children:e.jsx(f.Control,{children:e.jsx($,{min:0,max:i.quantity,type:"number",value:d,className:"bg-ui-bg-field-component text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",onChange:t=>{const s=t.target.value===""?null:parseFloat(t.target.value);c(s)},...y,onBlur:()=>{y.onBlur(),x(d)}})})})})]})})]})}var be=_e;function Ne({order:a,preview:i,orderReturn:r}){const{t:n}=M(),{handleSuccess:p}=te(),o=g.useMemo(()=>{const t={};return r.items.forEach(s=>t[s.item_id]=!0),i.items.filter(s=>t[s.id])},[i.items,r]),{mutateAsync:b}=G(r.id,a.id),{mutateAsync:w}=K(r.id,a.id),{mutateAsync:I}=F(r.id,a.id),{mutateAsync:q}=W(r.id,a.id),{mutateAsync:_}=J(r.id,a.id),{stock_location:N}=oe(r.location_id,void 0,{enabled:!!r.location_id}),E=g.useMemo(()=>{const t={};return a.items.forEach(s=>t[s.id]=s),t},[a.items]),x=ce({defaultValues:{items:o==null?void 0:o.sort((t,s)=>t.id.localeCompare(s.id)).map(t=>({item_id:t.id})),send_notification:!1},resolver:le(ve)});g.useEffect(()=>{o==null||o.sort((t,s)=>t.id.localeCompare(s.id)).forEach((t,s)=>{var j,v;const u=(j=t.actions)==null?void 0:j.find(m=>m.action==="RECEIVE_RETURN_ITEM"),l=(v=t.actions)==null?void 0:v.find(m=>m.action==="RECEIVE_DAMAGED_RETURN_ITEM");x.setValue(`items.${s}.quantity`,u==null?void 0:u.details.quantity,{shouldTouch:!0,shouldDirty:!0}),x.setValue(`items.${s}.dismissed_quantity`,l==null?void 0:l.details.quantity,{shouldTouch:!0,shouldDirty:!0})})},[o]);const c=x.handleSubmit(async t=>{try{await b({no_notification:!t.send_notification}),p(`/orders/${a.id}`),h.success(n("general.success"),{description:n("orders.returns.receive.toast.success"),dismissLabel:n("actions.close")})}catch(s){h.error(n("general.error"),{description:s.message,dismissLabel:n("actions.close")})}}),d=async(t,s,u)=>{var v;const l=o==null?void 0:o.find(m=>m.id===t),j=(v=l==null?void 0:l.actions)==null?void 0:v.find(m=>m.action==="RECEIVE_RETURN_ITEM");if(typeof s=="number"&&s<0){x.setValue(`items.${u}.quantity`,l.detail.return_received_quantity,{shouldTouch:!0,shouldDirty:!0}),h.error(n("orders.returns.receive.toast.errorNegativeValue"));return}if(typeof s=="number"&&s>l.quantity){x.setValue(`items.${u}.quantity`,l.detail.return_received_quantity,{shouldTouch:!0,shouldDirty:!0}),h.error(n("orders.returns.receive.toast.errorLargeValue"));return}try{if(j){if(s===null||s===0){await _(j.id);return}await q({actionId:j.id,quantity:s})}else typeof s=="number"&&s>0&&s<=l.quantity&&await I({items:[{id:l.id,quantity:s}]})}catch(m){h.error(m.message)}},y=async t=>{try{t||await w()}catch(s){h.error(s.message)}};return e.jsx(R.Form,{form:x,onClose:y,children:e.jsxs(ee,{onSubmit:c,className:"flex size-full flex-col overflow-hidden",children:[e.jsxs(R.Body,{className:"flex size-full flex-col overflow-auto",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("div",{children:N&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"text-ui-fg-subtle"})," ",e.jsx("span",{className:"text-ui-fg-base txt-small font-medium",children:N.name})]})}),e.jsx("span",{className:"text-ui-fg-muted txt-small text-right",children:n("orders.returns.receive.itemsLabel")})]}),o.map((t,s)=>{const u=E[t.id];return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest mt-2 rounded-xl",children:e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsxs(T,{size:"small",className:"text-ui-fg-subtle",children:[t.quantity,"x"]}),e.jsx(ue,{src:t.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(T,{className:"txt-small",as:"span",weight:"plus",children:[t.title," "]}),u.variant_sku&&e.jsxs("span",{children:["(",u.variant_sku,")"]})]}),e.jsx(T,{as:"div",className:"text-ui-fg-subtle txt-small",children:u.product_title})]})]}),e.jsxs("div",{className:"flex flex-1 flex-row items-center gap-2",children:[e.jsx(be,{form:x,item:t,index:s,returnId:r.id,orderId:a.id}),e.jsx(f.Field,{control:x.control,name:`items.${s}.quantity`,render:({field:{onChange:l,value:j,...v}})=>e.jsx(f.Item,{className:"w-full",children:e.jsx(f.Control,{children:e.jsx($,{min:0,max:t.quantity,type:"number",value:j,className:"bg-ui-bg-field-component text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",onChange:m=>{const z=m.target.value===""?null:parseFloat(m.target.value);l(z)},...v,onBlur:()=>{v.onBlur(),d(t.id,j,s)}})})})})]})]})},t.id)}),e.jsxs("div",{className:"my-6 border-b border-t border-dashed py-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:n("fields.total")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:O(i.total,a.currency_code)})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between border-t border-dotted pt-4",children:[e.jsx("span",{className:"txt-small font-medium",children:n("orders.returns.outstandingAmount")}),e.jsx("span",{className:"txt-small font-medium",children:O(i.summary.pending_difference||0,a.currency_code)})]})]}),e.jsx(pe,{className:"rounded-xl",variant:"warning",children:n("orders.returns.receive.inventoryWarning")}),e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl p-3",children:e.jsx(f.Field,{control:x.control,name:"send_notification",render:({field:{onChange:t,value:s,...u}})=>e.jsxs(f.Item,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(f.Control,{children:e.jsx(me,{dir:"ltr",className:"mt-1 self-start rtl:rotate-180",checked:!!s,onCheckedChange:t,...u})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(f.Label,{children:n("orders.returns.sendNotification")}),e.jsx(f.Hint,{className:"!mt-1",children:n("orders.returns.receive.sendNotificationHint")})]})]}),e.jsx(f.ErrorMessage,{})]})})})]}),e.jsx(R.Footer,{className:"overflow-hidden",children:e.jsxs("div",{className:"flex items-center gap-x-2",children:[e.jsx(R.Close,{asChild:!0,children:e.jsx(k,{size:"small",variant:"secondary",children:n("actions.cancel")})}),e.jsx(k,{size:"small",type:"submit",isLoading:!1,children:n("actions.save")})]})})]})})}var A=!1;function De(){const{id:a,return_id:i}=se(),{t:r}=M(),n=ae(),{order:p}=ie(a,{fields:"+currency_code,*items"}),{order:o}=re(a),{return:b}=H(i,{fields:"*items.item,*items.item.variant,*items.item.variant.product"}),{mutateAsync:w}=Q(i,a),{mutateAsync:I}=F(i,a);g.useEffect(()=>{(async function(){if(!(A||!o)){if(o.order_change){o.order_change.change_type!=="return_receive"&&(n(`/orders/${a}`,{replace:!0}),h.error(r("orders.returns.activeChangeError")));return}A=!0;try{const{return:_}=await w({});await I({items:_.items.map(N=>({id:N.item_id,quantity:N.quantity}))})}catch(_){h.error(_.message)}finally{A=!1}}})()},[o]);const q=p&&b&&o;return e.jsxs(R,{children:[e.jsx(R.Header,{children:e.jsx(ne,{children:r("orders.returns.receive.title",{returnId:i==null?void 0:i.slice(-7)})})}),q&&e.jsx(Ne,{order:p,orderReturn:b,preview:o})]})}export{De as Component};
