import{E as Z,U as $}from"./chunk-DODQ3KJT-CAgTascl.js";import"./chunk-ZQRKUG6J-C7OcWeCb.js";import{b as P,ah as J,ag as ee,j as e,au as se,r as j,aD as te,aE as ae,N as ie,Q as re,R as G,S as ne,U as le,V as oe,ak as W,s as de,t as K,B as I,L as B,W as ce,Z as ue,aV as he,X as me,Y as fe,am as T,c as xe,h as pe,a1 as D,T as ge,aW as be,a7 as je,a9 as ve,aa as ye,_ as z,al as H,a4 as X,a5 as O,aX as we,aS as Te}from"./index-BcvhWi3G.js";import{K as Ne}from"./chunk-6HTZNHPT-BJ6krZ6N.js";import{R as v,u as Ce}from"./chunk-AERWK3TJ-D_sd7NgU.js";import{T as F}from"./thumbnail-badge-C21wuhNV.js";import"./chunk-BYOPZAGX-DwJgWMZr.js";import"./chunk-6GU6IDUA-CDc7wW5L.js";var Se=({product:s})=>{const[t,i]=j.useState({}),{t:a}=P(),{handleSuccess:o}=Ce(),m=te({defaultValues:{media:ke(s.images,s.thumbnail)},resolver:ae(Z)}),{fields:l,append:r,remove:d,update:g}=ie({name:"media",control:m.control,keyName:"field_id"}),[h,p]=j.useState(null),C=re(G(oe),G(le,{coordinateGetter:ne})),w=n=>{p(n.active.id)},E=n=>{p(null);const{active:x,over:u}=n;if(x.id!==(u==null?void 0:u.id)){const b=l.findIndex(N=>N.field_id===x.id),L=l.findIndex(N=>N.field_id===(u==null?void 0:u.id));m.setValue("media",je(l,b,L),{shouldDirty:!0,shouldTouch:!0})}},c=()=>{p(null)},{mutateAsync:S,isPending:_}=W(s.id),M=m.handleSubmit(async({media:n})=>{var N;const x=n.map((f,k)=>({file:f.file,index:k})).filter(f=>!!f.file);let u=[];if(x.length){const{files:f}=await de.admin.upload.create({files:x.map(k=>k.file)}).catch(()=>(m.setError("media",{type:"invalid_file",message:a("products.media.failedToUpload")}),{files:[]}));u=f}const b=n.map((f,k)=>{var U;const R=x.findIndex(Q=>Q.index===k);return R>-1?{...f,url:(U=u[R])==null?void 0:U.url}:f}),L=(N=b.find(f=>f.isThumbnail))==null?void 0:N.url;await S({images:b.map(f=>({url:f.url,id:f.id})),thumbnail:L||null},{onSuccess:()=>{K.success(a("products.media.successToast")),o()},onError:f=>{K.error(f.message)}})}),y=j.useCallback(n=>x=>{if(x)i(u=>({...u,[n]:!0}));else{const{[n]:u,...b}=t;i(b)}},[t]),q=()=>{const x=Object.keys(t).map(u=>l.findIndex(b=>b.id===u));d(x),i({})},Y=()=>{const n=Object.keys(t);if(!n.length)return;const x=l.findIndex(b=>b.isThumbnail);x>-1&&g(x,{...l[x],isThumbnail:!1});const u=l.findIndex(b=>b.id===n[0]);g(u,{...l[u],isThumbnail:!0}),i({})},V=Object.keys(t).length;return e.jsx(v.Form,{blockSearchParams:!0,form:m,children:e.jsxs(Ne,{className:"flex size-full flex-col overflow-hidden",onSubmit:M,children:[e.jsx(v.Header,{children:e.jsx("div",{className:"flex items-center justify-end gap-x-2",children:e.jsx(I,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(B,{to:{pathname:".",search:void 0},children:a("products.media.galleryLabel")})})})}),e.jsx(v.Body,{className:"flex flex-col overflow-hidden",children:e.jsxs("div",{className:"flex size-full flex-col-reverse lg:grid lg:grid-cols-[1fr_560px]",children:[e.jsx(ce,{sensors:C,onDragEnd:E,onDragStart:w,onDragCancel:c,children:e.jsx("div",{className:"bg-ui-bg-subtle size-full overflow-auto",children:e.jsxs("div",{className:"grid h-fit auto-rows-auto grid-cols-4 gap-6 p-6",children:[e.jsx(ue,{items:l.map(n=>n.field_id),strategy:he,children:l.map(n=>e.jsx(ze,{onCheckedChange:y(n.id),checked:!!t[n.id],media:n},n.field_id))}),e.jsx(me,{dropAnimation:Ie,children:h?e.jsx(Pe,{media:l.find(n=>n.field_id===h),checked:!!t[l.find(n=>n.field_id===h).id]}):null})]})})}),e.jsx("div",{className:"bg-ui-bg-base overflow-auto border-b px-6 py-4 lg:border-b-0 lg:border-l",children:e.jsx($,{form:m,append:r})})]})}),e.jsx(T,{open:!!V,children:e.jsxs(T.Bar,{children:[e.jsx(T.Value,{children:a("general.countSelected",{count:V})}),e.jsx(T.Seperator,{}),V===1&&e.jsxs(j.Fragment,{children:[e.jsx(T.Command,{action:Y,label:a("products.media.makeThumbnail"),shortcut:"t"}),e.jsx(T.Seperator,{})]}),e.jsx(T.Command,{action:q,label:a("actions.delete"),shortcut:"d"})]})}),e.jsx(v.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(v.Close,{asChild:!0,children:e.jsx(I,{variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(I,{size:"small",type:"submit",isLoading:_,children:a("actions.save")})]})})]})})},ke=(s,t)=>{const i=(s==null?void 0:s.map(a=>({id:a.id,url:a.url,isThumbnail:a.url===t,file:null})))||[];if(t&&!i.some(a=>a.url===t)){const a=Math.random().toString(36).substring(7);i.unshift({id:a,url:t,isThumbnail:!0,file:null})}return i},Ie={sideEffects:fe({styles:{active:{opacity:"0.4"}}})},ze=({media:s,checked:t,onCheckedChange:i})=>{const{t:a}=P(),o=j.useCallback(w=>{i(w)},[i]),{attributes:m,listeners:l,setNodeRef:r,setActivatorNodeRef:d,transform:g,transition:h,isDragging:p}=ve({id:s.field_id}),C={opacity:p?.4:void 0,transform:ye.Transform.toString(g),transition:h};return e.jsxs("div",{className:z("shadow-elevation-card-rest hover:shadow-elevation-card-hover focus-visible:shadow-borders-focus bg-ui-bg-subtle-hover group relative aspect-square h-auto max-w-full overflow-hidden rounded-lg outline-none"),style:C,ref:r,children:[s.isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(H,{content:a("products.media.thumbnailTooltip"),children:e.jsx(F,{})})}),e.jsx("div",{className:z("absolute inset-0 cursor-grab touch-none outline-none",{"cursor-grabbing":p}),ref:d,...m,...l}),e.jsx("div",{className:z("transition-fg absolute right-2 top-2 opacity-0",{"group-focus-within:opacity-100 group-hover:opacity-100 group-focus:opacity-100":!p&&!t,"opacity-100":t}),children:e.jsx(X,{onClick:w=>{w.stopPropagation()},checked:t,onCheckedChange:o})}),e.jsx("img",{src:s.url,alt:"",className:"size-full object-cover object-center"})]})},Pe=({media:s,checked:t})=>e.jsxs("div",{className:"shadow-elevation-card-rest hover:shadow-elevation-card-hover focus-visible:shadow-borders-focus bg-ui-bg-subtle-hover group relative aspect-square h-auto max-w-full cursor-grabbing overflow-hidden rounded-lg outline-none",children:[s.isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(F,{})}),e.jsx("div",{className:z("transition-fg absolute right-2 top-2 opacity-0",{"opacity-100":t}),children:e.jsx(X,{checked:t})}),e.jsx("img",{src:s.url,alt:"",className:"size-full object-cover object-center"})]}),Ee=({product:s})=>{const{state:t}=xe(),[i,a]=j.useState((t==null?void 0:t.curr)||0),{t:o}=P(),m=pe(),{mutateAsync:l,isPending:r}=W(s.id),d=_e(s.images,s.thumbnail),g=j.useCallback(()=>{r||a(c=>(c+1)%d.length)},[d,r]),h=j.useCallback(()=>{r||a(c=>(c-1+d.length)%d.length)},[d,r]),p=j.useCallback(c=>{r||a(c)},[r]),C=()=>{if(r)return;const c=document.createElement("a");c.href=d[i].url,c.download="image",c.target="_blank",c.click()},w=async()=>{var M;const c=d[i];if(!await m({title:o("general.areYouSure"),description:c.isThumbnail?o("products.media.deleteWarningWithThumbnail",{count:1}):o("products.media.deleteWarning",{count:1}),confirmText:o("actions.delete"),cancelText:o("actions.cancel")}))return;const _=((M=s.images)==null?void 0:M.filter(y=>y.id!==c.id).map(y=>({id:y.id,url:y.url})))||[];i===d.length-1&&a(y=>y-1),await l({images:_,thumbnail:c.isThumbnail?"":void 0})};j.useEffect(()=>{const c=S=>{S.key==="ArrowRight"?g():S.key==="ArrowLeft"&&h()};return document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}},[g,h]);const E=!d.length;return e.jsxs("div",{className:"flex size-full flex-col overflow-hidden",children:[e.jsx(v.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsxs(D,{size:"small",type:"button",onClick:w,disabled:E,children:[e.jsx(ge,{}),e.jsx("span",{className:"sr-only",children:o("products.media.deleteImageLabel")})]}),e.jsxs(D,{size:"small",type:"button",onClick:C,disabled:E,children:[e.jsx(be,{}),e.jsx("span",{className:"sr-only",children:o("products.media.downloadImageLabel")})]}),e.jsx(I,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(B,{to:{pathname:".",search:"view=edit"},children:o("actions.edit")})})]})}),e.jsxs(v.Body,{className:"flex flex-col overflow-hidden",children:[e.jsx(Me,{curr:i,media:d}),e.jsx(De,{curr:i,media:d,prev:h,next:g,goTo:p})]})]})},Me=({media:s,curr:t})=>{const{t:i}=P();return s.length===0?e.jsxs("div",{className:"bg-ui-bg-subtle flex size-full flex-col items-center justify-center gap-y-4 pb-8 pt-6",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(O,{size:"small",leading:"compact",weight:"plus",className:"text-ui-fg-subtle",children:i("products.media.emptyState.header")}),e.jsx(O,{size:"small",className:"text-ui-fg-muted",children:i("products.media.emptyState.description")})]}),e.jsx(I,{size:"small",variant:"secondary",asChild:!0,children:e.jsx(B,{to:"?view=edit",children:i("products.media.emptyState.action")})})]}):e.jsx("div",{className:"bg-ui-bg-subtle relative size-full overflow-hidden",children:e.jsx("div",{className:"flex size-full items-center justify-center p-6",children:e.jsxs("div",{className:"relative inline-block max-h-full max-w-full",children:[s[t].isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(H,{content:i("products.media.thumbnailTooltip"),children:e.jsx(F,{})})}),e.jsx("img",{src:s[t].url,alt:"",className:"object-fit shadow-elevation-card-rest max-h-[calc(100vh-200px)] w-auto rounded-xl object-contain"})]})})})},A=8,De=({media:s,curr:t,prev:i,next:a,goTo:o})=>{if(!s.length)return null;const l=((r,d)=>{if(r.length<=A)return r;const g=Math.floor(A/2),h=(d-g+r.length)%r.length,p=(h+A)%r.length;return p<h?[...r.slice(h),...r.slice(0,p)]:r.slice(h,p)})(s,t);return e.jsxs("div",{className:"flex shrink-0 items-center justify-center gap-x-2 border-t p-3",children:[e.jsx(D,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:i,children:e.jsx(we,{className:"rtl:rotate-180"})}),e.jsx("div",{className:"flex items-center gap-x-2",children:l.map(r=>{const d=r.id===s[t].id,g=s.findIndex(h=>h.id===r.id);return e.jsx("button",{type:"button",onClick:()=>o(g),className:z("transition-fg size-7 overflow-hidden rounded-[4px] outline-none",{"shadow-borders-focus":d}),children:e.jsx("img",{src:r.url,alt:"",className:"size-full object-cover"})},r.id)})}),e.jsx(D,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:a,children:e.jsx(Te,{className:"rtl:rotate-180"})})]})},_e=(s,t)=>{const i=(s==null?void 0:s.map(a=>({id:a.id,url:a.url,isThumbnail:a.url===t})))||[];return t&&!i.some(a=>a.isThumbnail)&&i.unshift({id:"thumbnail_only",url:t,isThumbnail:!0}),i},Ve=j.createContext(null),Le=s=>s.get("view")==="edit"?"edit":"gallery",Ae=({product:s})=>{const[t,i]=se(),a=Le(t),o=m=>()=>{i({view:m})};return e.jsx(Ve.Provider,{value:{goToGallery:o("gallery"),goToEdit:o("edit")},children:Be(a,s)})},Be=(s,t)=>{switch(s){case"gallery":return e.jsx(Ee,{product:t});case"edit":return e.jsx(Se,{product:t})}},Xe=()=>{const{t:s}=P(),{id:t}=J(),{product:i,isLoading:a,isError:o,error:m}=ee(t),l=!a&&i;if(o)throw m;return e.jsxs(v,{children:[e.jsx(v.Title,{asChild:!0,children:e.jsx("span",{className:"sr-only",children:s("products.media.label")})}),e.jsx(v.Description,{asChild:!0,children:e.jsx("span",{className:"sr-only",children:s("products.media.editHint")})}),l&&e.jsx(Ae,{product:i})]})};export{Xe as Component};
