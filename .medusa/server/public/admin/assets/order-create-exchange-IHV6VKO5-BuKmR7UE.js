import{c as Je,d as Xe,e as Ke,u as We,f as Ze,g as Ye,h as et,i as tt,j as st,k as nt,l as it,m as at,n as ot,o as rt,p as lt,q as dt}from"./chunk-KWP436SM-DGQ_6TJx.js";import{I as Me}from"./chunk-QJ6SBVJ2-BytNzia4.js";import{g as ct}from"./chunk-UC26CCHZ-DbXuoyCH.js";import{R as ut,O as mt,C as ht}from"./chunk-P3DRE4IY-DrLokTpz.js";import{g as Ae}from"./chunk-PXZ7QYKX-DZ_CHK12.js";import{D as pt}from"./chunk-C7F7MMXS-BXIPDtJe.js";import{c as xt,o as ft}from"./chunk-REUYEF7L-BCB7O_FO.js";import{M as Te}from"./chunk-INE2QCSC-CrrDQrH-.js";import{P as De,a as Re}from"./chunk-IQBAUTU5-jvNXNAr8.js";import{a as ee}from"./chunk-X6BAAGCL-Cmzs-01s.js";import{ah as gt,u as _t,b as G,dd as bt,de as jt,r as I,j as e,t as q,dS as yt,aD as vt,aE as It,ax as oe,h as Nt,H as pe,a1 as ne,P as ge,dO as _e,J as p,aG as be,al as xe,d6 as St,B as te,ay as je,az as K,aI as ye,aK as ve,dM as Et,N as qe,a5 as $,dQ as Ct,s as Oe,dP as Pt,av as we,dr as He,K as he,A as Fe,dt as kt,a8 as Ie,dR as Mt,g as Le,a4 as ie}from"./index-DsV72Lgh.js";import{u as ze,_ as Be}from"./chunk-YTN73JYH-CNuodvoK.js";import{C as ae}from"./chunk-OFN7DIZA-CpT302SF.js";import{c as Ne}from"./chunk-DK4WIVY6-CYCbBMOO.js";import"./chunk-GU5PJRPM-O5M6LXf4.js";import{u as Ve}from"./chunk-C76H5USB-CiyvsDlP.js";import{K as At}from"./chunk-6HTZNHPT-DGQV_Lcz.js";import{R as X,u as Tt,a as Ge,S as U}from"./chunk-AERWK3TJ-DmmmqBU-.js";import{u as Dt}from"./chunk-HBXV7ENS-D2Tti13O.js";import{X as Ue}from"./x-circle-BveR4TGP.js";import{A as $e}from"./alert-DxcP6O8k.js";import"./Trans-J1LkaaR0.js";import"./chunk-P3UUX2T6-BC4tQC_j.js";import"./chunk-HQKGZADC-Dbir7G86.js";import"./chunk-EMIHDNB7-DRJ-T97v.js";import"./chunk-DZWH2RV6-DwC22Jxm.js";import"./index-Do-4R60H.js";var Rt=oe({inbound_items:ye(oe({item_id:K(),quantity:ve(),reason_id:K().nullish(),note:K().nullish()})),outbound_items:ye(oe({item_id:K(),quantity:ve()})),location_id:K().optional(),inbound_option_id:K().nullish(),outbound_option_id:K().nullish(),send_notification:je().optional(),carry_over_promotions:je().optional()}),Y=Le(),qt=t=>{const{t:n}=G();return I.useMemo(()=>[Y.display({id:"select",header:({table:a})=>e.jsx(ie,{checked:a.getIsSomePageRowsSelected()?"indeterminate":a.getIsAllPageRowsSelected(),onCheckedChange:o=>a.toggleAllPageRowsSelected(!!o)}),cell:({row:a})=>{const o=a.getCanSelect();return e.jsx(ie,{disabled:!o,checked:a.getIsSelected(),onCheckedChange:i=>a.toggleSelected(!!i),onClick:i=>{i.stopPropagation()}})}}),Y.display({id:"product",header:()=>e.jsx(Re,{}),cell:({row:a})=>e.jsx(De,{product:{thumbnail:a.original.thumbnail,title:a.original.product_title}})}),Y.accessor("variant.sku",{header:n("fields.sku"),cell:({getValue:a})=>a()||"-"}),Y.accessor("variant.title",{header:n("fields.variant")}),Y.accessor("quantity",{header:()=>e.jsx("div",{className:"flex size-full items-center overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:n("fields.quantity")})}),cell:({getValue:a,row:o})=>Ae(o.original)}),Y.accessor("refundable_total",{header:()=>e.jsx("div",{className:"flex size-full items-center justify-end overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:n("fields.price")})}),cell:({getValue:a})=>{const o=a()||0,i=ee(o,t);return e.jsx("div",{className:"flex size-full items-center justify-end overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:i})})}})],[n,t])},Ot=()=>{const{t}=G();return[{key:"created_at",label:t("fields.createdAt"),type:"date"},{key:"updated_at",label:t("fields.updatedAt"),type:"date"}]},wt=({pageSize:t=50,prefix:n})=>{const a=Ve(["q","offset","order","created_at","updated_at"],n),{offset:o,created_at:i,updated_at:x,...b}=a;return{searchParams:{...b,limit:t,offset:o?Number(o):0,created_at:i?JSON.parse(i):void 0,updated_at:x?JSON.parse(x):void 0},raw:a}},re=50,Se="rit",Ht=({onSelectionChange:t,selectedItems:n,items:a,currencyCode:o})=>{const{t:i}=G(),[x,b]=I.useState(n.reduce((j,N)=>(j[N]=!0,j),{})),P=j=>{const N=typeof j=="function"?j(x):j;b(N),t(Object.keys(N))},{searchParams:y,raw:k}=wt({pageSize:re,prefix:Se}),T=I.useMemo(()=>{const{order:j,offset:N,limit:F,q:S,created_at:L,updated_at:Q}=y;let w=a;if(S&&(w=w.filter(B=>{var M;return B.product_title.toLowerCase().includes(S.toLowerCase())||B.variant_title.toLowerCase().includes(S.toLowerCase())||((M=B.variant_sku)==null?void 0:M.toLowerCase().includes(S.toLowerCase()))})),j){const B=j[0]==="-"?"desc":"asc",M=j.replace("-","");w=Ft(w,M,B)}return L&&(w=Ee(w,L,"created_at")),Q&&(w=Ee(w,Q,"updated_at")),w.slice(N,N+F)},[a,o,y]),A=qt(o),H=Ot(),{table:R}=ze({data:T,columns:A,count:T.length,enablePagination:!0,getRowId:j=>j.id,pageSize:re,enableRowSelection:j=>Ae(j.original)>0,rowSelection:{state:x,updater:P}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(Be,{table:R,columns:A,pageSize:re,count:T.length,filters:H,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_title",label:i("fields.product")},{key:"variant_title",label:i("fields.variant")},{key:"sku",label:i("fields.sku")}],prefix:Se,queryObject:k})})},Ft=(t,n,a)=>t.sort((o,i)=>{let x,b;return n==="product_title"?(x=o.product_title,b=i.product_title):n==="variant_title"?(x=o.variant_title,b=i.variant_title):n==="sku"&&(x=o.variant_sku,b=i.variant_sku),x<b?a==="asc"?-1:1:x>b?a==="asc"?1:-1:0}),Ee=(t,n,a)=>{const{gt:o,gte:i,lt:x,lte:b}=n;return t.filter(P=>{const y=new Date(P[a]);let k=!0;return o&&(k=k&&y>new Date(o)),i&&(k=k&&y>=new Date(i)),x&&(k=k&&y<new Date(x)),b&&(k=k&&y<=new Date(b)),k})};function Lt({item:t,previewItem:n,currencyCode:a,form:o,onRemove:i,onUpdate:x,index:b}){const{t:P}=G(),{return_reasons:y=[]}=Pt({fields:"+label"}),k=o.watch(`inbound_items.${b}`),T=typeof k.reason_id=="string",A=typeof k.note=="string",H=(n.adjustments||[]).map(R=>R.code);return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:[e.jsxs("div",{className:"flex flex-col items-center gap-x-3 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(we,{src:t.thumbnail}),e.jsxs("div",{className:"flex flex-grow flex-col",children:[e.jsxs("div",{children:[e.jsxs($,{className:"txt-small",as:"span",weight:"plus",children:[t.title," "]}),t.variant_sku&&e.jsxs("span",{children:["(",t.variant_sku,")"]})]}),e.jsx($,{as:"div",className:"text-ui-fg-subtle txt-small",children:t.product_title})]}),H.length>0&&e.jsx("div",{className:"flex flex-shrink",children:e.jsx(xe,{content:e.jsx("span",{className:"text-pretty",children:H.map(R=>e.jsx("div",{children:R},R))}),children:e.jsx(He,{className:"text-ui-fg-subtle"})})})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(p.Field,{control:o.control,name:`inbound_items.${b}.quantity`,render:({field:R})=>e.jsxs(p.Item,{children:[e.jsx(p.Control,{children:e.jsx(he,{...R,className:"bg-ui-bg-base txt-small w-[67px] rounded-lg",min:1,max:t.quantity,type:"number",onBlur:j=>{const N=j.target.value,F=N===""?null:Number(N);R.onChange(F),F&&x({quantity:F})}})}),e.jsx(p.ErrorMessage,{})]})}),e.jsx($,{className:"txt-small text-ui-fg-subtle",children:P("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(Te,{currencyCode:a,amount:n.return_requested_total})}),e.jsx(Fe,{groups:[{actions:[!T&&{label:P("actions.addReason"),onClick:()=>o.setValue(`inbound_items.${b}.reason_id`,""),icon:e.jsx(ht,{})},!A&&{label:P("actions.addNote"),onClick:()=>o.setValue(`inbound_items.${b}.note`,""),icon:e.jsx(kt,{})},{label:P("actions.remove"),onClick:i,icon:e.jsx(Ue,{})}].filter(Boolean)}]})]})]}),e.jsxs(e.Fragment,{children:[T&&e.jsxs("div",{className:"grid grid-cols-1 gap-2 p-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(p.Label,{children:P("orders.returns.reason")}),e.jsx(p.Hint,{className:"!mt-1",children:P("orders.returns.reasonHint")})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(p.Field,{control:o.control,name:`inbound_items.${b}.reason_id`,render:({field:{ref:R,value:j,onChange:N,...F}})=>e.jsxs(p.Item,{children:[e.jsx(p.Control,{children:e.jsx(ae,{className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover",value:j,onChange:S=>{x({reason_id:S}),N(S)},...F,options:y.map(S=>({label:S.label,value:S.id}))})}),e.jsx(p.ErrorMessage,{})]})})}),e.jsx(ne,{type:"button",className:"flex-shrink",variant:"transparent",onClick:()=>{o.setValue(`inbound_items.${b}.reason_id`,null),x({reason_id:null})},children:e.jsx(Ie,{className:"text-ui-fg-muted"})})]})]}),A&&e.jsxs("div",{className:"grid grid-cols-1 gap-2 p-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(p.Label,{children:P("orders.returns.note")}),e.jsx(p.Hint,{className:"!mt-1",children:P("orders.returns.noteHint")})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(p.Field,{control:o.control,name:`inbound_items.${b}.note`,render:({field:{ref:R,...j}})=>e.jsxs(p.Item,{children:[e.jsx(p.Control,{children:e.jsx(he,{...j,onBlur:()=>{j.onChange(j.value),x({internal_note:j.value})},className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover"})}),e.jsx(p.ErrorMessage,{})]})})}),e.jsx(ne,{type:"button",className:"flex-shrink",variant:"transparent",onClick:()=>{o.setValue(`inbound_items.${b}.note`,null),x({internal_note:null})},children:e.jsx(Ie,{className:"text-ui-fg-muted"})})]})]})]})]})}var le=[],Ce=[],zt=({order:t,preview:n,exchange:a,form:o,orderReturn:i})=>{var D;const{t:x}=G(),{setIsOpen:b}=Ge(),[P,y]=I.useState({}),{mutateAsync:k}=ft((D=n==null?void 0:n.order_change)==null?void 0:D.return_id,t.id),{mutateAsync:T}=et(a.id,t.id),{mutateAsync:A}=tt(a.id,t.id),{mutateAsync:H}=st(a.id,t.id),{mutateAsync:R}=nt(a.id,t.id),{mutateAsync:j}=it(a.id,t.id),N=I.useMemo(()=>{var r;return(r=n==null?void 0:n.items)==null?void 0:r.filter(u=>{var h;return!!((h=u.actions)!=null&&h.find(f=>f.exchange_id===a.id))})},[n.items]),F=N.filter(r=>{var u;return!!((u=r.actions)!=null&&u.find(h=>h.action==="RETURN_ITEM"))}),S=I.useMemo(()=>{var r;return new Map((r=t==null?void 0:t.items)==null?void 0:r.map(u=>[u.id,u]))},[t.items]),L=o.watch("location_id"),{stock_locations:Q=[]}=Et({limit:999}),{shipping_options:w=[]}=Dt({limit:999,fields:"*prices,+service_zone.fulfillment_set.location.id",stock_location_id:L},{enabled:!!L}),B=w.filter(r=>!!r.rules.find(u=>u.attribute==="is_return"&&u.value==="true")),{fields:M,append:W,remove:Z,update:V}=qe({name:"inbound_items",control:o.control}),z=I.useMemo(()=>new Map(N.map(r=>[r.id,r])),[N,M]);I.useEffect(()=>{const r={};F.forEach(u=>{var f,C;const h=M.findIndex(s=>s.item_id===u.id);if(r[u.id]=!0,h>-1){if(M[h].quantity!==u.detail.return_requested_quantity){const s=(f=u.actions)==null?void 0:f.find(l=>l.action==="RETURN_ITEM");V(h,{...M[h],quantity:u.detail.return_requested_quantity,note:s==null?void 0:s.internal_note,reason_id:(C=s==null?void 0:s.details)==null?void 0:C.reason_id})}}else W({item_id:u.id,quantity:u.detail.return_requested_quantity},{shouldFocus:!1})}),M.forEach((u,h)=>{u.item_id in r||Z(h)})},[N]),I.useEffect(()=>{const r=n.shipping_methods.find(u=>{var h;return(h=u.actions)==null?void 0:h.find(f=>f.action==="SHIPPING_ADD"&&!!f.return_id)});r?o.setValue("inbound_option_id",r.shipping_option_id):o.setValue("inbound_option_id","")},[n.shipping_methods]),I.useEffect(()=>{o.setValue("location_id",i==null?void 0:i.location_id)},[i]);const _=!M.length,m=async()=>{var r,u,h;le.length&&await H({items:le.map(f=>({id:f,quantity:1}))},{onError:f=>{q.error(f.message)}});for(const f of Ce){const C=(h=(u=(r=N.find(s=>s.id===f))==null?void 0:r.actions)==null?void 0:u.find(s=>s.action==="RETURN_ITEM"))==null?void 0:h.id;C&&await j(C,{onError:s=>{q.error(s.message)}})}b("inbound-items",!1)},c=async r=>{await k({location_id:r})},g=async r=>{const h=n.shipping_methods.filter(f=>{var C;return(C=f.actions)==null?void 0:C.find(s=>s.action==="SHIPPING_ADD"&&!!s.return_id)}).filter(Boolean).map(f=>{var s;const C=(s=f.actions)==null?void 0:s.find(l=>l.action==="SHIPPING_ADD"&&!!l.return_id);if(C)return A(C.id)});await Promise.all(h),r&&await T({shipping_option_id:r},{onError:f=>{q.error(f.message)}})},E=I.useMemo(()=>L?!M.map(u=>{var f,C;const h=S.get(u.item_id);return!(h!=null&&h.variant_id)||!(h!=null&&h.variant)||!((f=h.variant)!=null&&f.manage_inventory)?!0:(C=P[h.variant_id])==null?void 0:C.find(s=>s.location_id===L)}).every(Boolean):!1,[M,P,L]);return I.useEffect(()=>{(async()=>{const u={};if(!M.length)return u;const h=M.map(C=>C==null?void 0:C.variant_id).filter(Boolean);return(await Oe.admin.productVariant.list({id:h,fields:"*inventory.location_levels"})).variants.forEach(C=>{var s,l;u[C.id]=((l=(s=C.inventory)==null?void 0:s[0])==null?void 0:l.location_levels)||[]}),u})().then(u=>{y(u)})},[M]),e.jsxs("div",{children:[e.jsxs("div",{className:"mt-8 flex items-center justify-between",children:[e.jsx(pe,{level:"h2",children:x("orders.returns.inbound")}),e.jsxs(U,{id:"inbound-items",children:[e.jsx(U.Trigger,{asChild:!0,children:e.jsx("a",{className:"focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400",children:x("actions.addItems")})}),e.jsxs(U.Content,{children:[e.jsx(U.Header,{}),e.jsx(Ht,{items:t.items,selectedItems:M.map(r=>r.item_id),currencyCode:t.currency_code,onSelectionChange:r=>{const u=M.map(h=>h.item_id);le=r.filter(h=>!u.includes(h)),Ce=u.filter(h=>!r.includes(h))}}),e.jsx(U.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(X.Close,{asChild:!0,children:e.jsx(te,{type:"button",variant:"secondary",size:"small",children:x("actions.cancel")})}),e.jsx(te,{type:"submit",variant:"primary",size:"small",role:"button",onClick:async()=>await m(),children:x("actions.save")},"submit-button")]})})})]})]})]}),_&&e.jsx(Me,{}),M.map((r,u)=>z.get(r.item_id)&&S.get(r.item_id)&&e.jsx(Lt,{item:S.get(r.item_id),previewItem:z.get(r.item_id),currencyCode:t.currency_code,form:o,onRemove:()=>{var f,C,s;const h=(s=(C=(f=N.find(l=>l.id===r.item_id))==null?void 0:f.actions)==null?void 0:C.find(l=>l.action==="RETURN_ITEM"))==null?void 0:s.id;h&&j(h,{onError:l=>{q.error(l.message)}})},onUpdate:h=>{var C,s;const f=(s=(C=N.find(l=>l.id===r.item_id))==null?void 0:C.actions)==null?void 0:s.find(l=>l.action==="RETURN_ITEM");f&&R({...h,actionId:f.id},{onError:l=>{var d,v;(d=f.details)!=null&&d.quantity&&h.quantity&&o.setValue(`inbound_items.${u}.quantity`,(v=f.details)==null?void 0:v.quantity),q.error(l.message)}})},index:u},r.id)),!_&&e.jsxs("div",{className:"mt-8 flex flex-col gap-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(p.Label,{children:x("orders.returns.location")}),e.jsx(p.Hint,{className:"!mt-1",children:x("orders.returns.locationHint")})]}),e.jsx(p.Field,{control:o.control,name:"location_id",render:({field:{value:r,onChange:u,...h}})=>e.jsx(p.Item,{children:e.jsx(p.Control,{children:e.jsx(ae,{...h,value:r??void 0,onChange:f=>{u(f),c(f)},options:(Q??[]).map(f=>({label:f.name,value:f.id}))})})})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsxs(p.Label,{children:[x("orders.returns.inboundShipping"),e.jsxs($,{size:"small",leading:"compact",className:"text-ui-fg-muted ml-1 inline",children:["(",x("fields.optional"),")"]})]}),e.jsx(p.Hint,{className:"!mt-1",children:x("orders.returns.inboundShippingHint")})]}),e.jsx(p.Field,{control:o.control,name:"inbound_option_id",render:({field:{value:r,onChange:u,...h}})=>e.jsx(p.Item,{children:e.jsx(p.Control,{children:e.jsx(ae,{allowClear:!0,value:r??void 0,onChange:f=>{u(f),g(f)},...h,options:B.map(f=>({label:f.name,value:f.id})),disabled:!L,noResultsPlaceholder:e.jsx(ut,{})})})})})]})]}),E&&e.jsxs($e,{variant:"warning",dismissible:!0,className:"mt-4 p-5",children:[e.jsx("div",{className:"text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]",children:x("orders.returns.noInventoryLevel")}),e.jsx($,{className:"text-ui-fg-subtle txt-small leading-normal",children:x("orders.returns.noInventoryLevelDesc")})]})]})},se=Le(),Bt=t=>{const{t:n}=G();return I.useMemo(()=>[se.display({id:"select",header:({table:a})=>e.jsx(ie,{checked:a.getIsSomePageRowsSelected()?"indeterminate":a.getIsAllPageRowsSelected(),onCheckedChange:o=>a.toggleAllPageRowsSelected(!!o)}),cell:({row:a})=>{const o=a.getCanSelect();return e.jsx(ie,{disabled:!o,checked:a.getIsSelected(),onCheckedChange:i=>a.toggleSelected(!!i),onClick:i=>{i.stopPropagation()}})}}),se.display({id:"product",header:()=>e.jsx(Re,{}),cell:({row:a})=>e.jsx(De,{product:a.original.product})}),se.accessor("sku",{header:n("fields.sku"),cell:({getValue:a})=>a()||"-"}),se.accessor("title",{header:n("fields.title")})],[n,t])},Vt=()=>{const{t}=G();return[{key:"created_at",label:t("fields.createdAt"),type:"date"},{key:"updated_at",label:t("fields.updatedAt"),type:"date"}]},Gt=({pageSize:t=50,prefix:n})=>{const a=Ve(["q","offset","order","created_at","updated_at"],n),{offset:o,created_at:i,updated_at:x,...b}=a;return{searchParams:{...b,limit:t,offset:o?Number(o):0,created_at:i?JSON.parse(i):void 0,updated_at:x?JSON.parse(x):void 0},raw:a}},de=50,Pe="rit",Ut=({onSelectionChange:t,selectedItems:n,currencyCode:a})=>{const{t:o}=G(),[i,x]=I.useState(n.reduce((j,N)=>(j[N]=!0,j),{})),b=j=>{const N=typeof j=="function"?j(i):j;x(N),t(Object.keys(N))},{searchParams:P,raw:y}=Gt({pageSize:de,prefix:Pe}),{variants:k=[],count:T}=Mt({...P,fields:"*inventory_items.inventory.location_levels,+inventory_quantity"}),A=Bt(a),H=Vt(),{table:R}=ze({data:k,columns:A,count:T,enablePagination:!0,getRowId:j=>j.id,pageSize:de,enableRowSelection:j=>!0,rowSelection:{state:i,updater:b}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(Be,{table:R,columns:A,pageSize:de,count:T,filters:H,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_id",label:o("fields.product")},{key:"title",label:o("fields.title")},{key:"sku",label:o("fields.sku")}],prefix:Pe,queryObject:y})})};function $t({previewItem:t,currencyCode:n,form:a,onRemove:o,onUpdate:i,index:x}){const{t:b}=G(),P=(t.adjustments||[]).map(y=>y.code);return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:e.jsxs("div",{className:"flex flex-col items-center gap-x-3 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(we,{src:t.thumbnail}),e.jsxs("div",{className:"flex flex-grow flex-col",children:[e.jsxs("div",{children:[e.jsxs($,{className:"txt-small",as:"span",weight:"plus",children:[t.title," "]}),t.variant_sku&&e.jsxs("span",{children:["(",t.variant_sku,")"]})]}),e.jsx($,{as:"div",className:"text-ui-fg-subtle txt-small",children:t.subtitle})]}),P.length>0&&e.jsx("div",{className:"flex flex-shrink",children:e.jsx(xe,{content:e.jsx("span",{className:"text-pretty",children:P.map(y=>e.jsx("div",{children:y},y))}),children:e.jsx(He,{className:"text-ui-fg-subtle"})})})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(p.Field,{control:a.control,name:`outbound_items.${x}.quantity`,render:({field:y})=>e.jsxs(p.Item,{children:[e.jsx(p.Control,{children:e.jsx(he,{...y,className:"bg-ui-bg-base txt-small w-[67px] rounded-lg",min:1,type:"number",onBlur:k=>{const T=k.target.value,A=T===""?null:Number(T);y.onChange(A),A&&i({quantity:A})}})}),e.jsx(p.ErrorMessage,{})]})}),e.jsx($,{className:"txt-small text-ui-fg-subtle",children:b("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(Te,{currencyCode:n,amount:t.total})}),e.jsx(Fe,{groups:[{actions:[{label:b("actions.remove"),onClick:o,icon:e.jsx(Ue,{})}].filter(Boolean)}]})]})]})})}var ce=[],ke=[],Qt=({order:t,preview:n,exchange:a,form:o})=>{const{t:i}=G(),{setIsOpen:x}=Ge(),[b,P]=I.useState({}),{shipping_options:y=[]}=Ct(t.id),k=y.filter(_=>{var m;return!((m=_.rules)!=null&&m.find(c=>c.attribute==="is_return"&&c.value==="true"))}),{mutateAsync:T}=at(a.id,t.id),{mutateAsync:A}=ot(a.id,t.id),{mutateAsync:H}=rt(a.id,t.id),{mutateAsync:R}=lt(a.id,t.id),{mutateAsync:j}=dt(a.id,t.id),N=I.useMemo(()=>{var _;return(_=n==null?void 0:n.items)==null?void 0:_.filter(m=>{var c;return!!((c=m.actions)!=null&&c.find(g=>g.exchange_id===a.id&&g.action==="ITEM_ADD"))})},[n.items]),F=I.useMemo(()=>{var _;return new Map((_=t==null?void 0:t.items)==null?void 0:_.map(m=>[m.variant_id,m]))},[t.items]),{fields:S,append:L,remove:Q,update:w}=qe({name:"outbound_items",control:o.control}),B=I.useMemo(()=>new Map(N.map(_=>[_.variant_id,_])),[N,S]);I.useEffect(()=>{const _={};N.forEach(m=>{const c=S.findIndex(g=>g.item_id===m.id);_[m.id]=!0,c>-1?S[c].quantity!==m.detail.quantity&&w(c,{...S[c],quantity:m.detail.quantity}):L({item_id:m.id,quantity:m.detail.quantity,variant_id:m.variant_id},{shouldFocus:!1})}),S.forEach((m,c)=>{m.item_id in _||Q(c)})},[N]);const M=o.watch("location_id"),W=!S.length,Z=async()=>{var _,m;ce.length&&await H({items:ce.map(c=>({variant_id:c,quantity:1}))},{onError:c=>{q.error(c.message)}});for(const c of ke){const g=(m=(_=N.find(E=>E.variant_id===c))==null?void 0:_.actions)==null?void 0:m.find(E=>E.action==="ITEM_ADD");g!=null&&g.id&&await j(g==null?void 0:g.id,{onError:E=>{q.error(E.message)}})}x("outbound-items",!1)};I.useEffect(()=>{const _=n.shipping_methods.find(m=>{var c;return!!((c=m.actions)!=null&&c.find(g=>g.action==="SHIPPING_ADD"&&!g.return_id))});_?o.setValue("outbound_option_id",_.shipping_option_id):o.setValue("outbound_option_id","")},[n.shipping_methods]);const V=async _=>{const c=n.shipping_methods.filter(g=>{var E;return!!((E=g.actions)!=null&&E.find(D=>D.action==="SHIPPING_ADD"&&!D.return_id))}).filter(Boolean).map(g=>{var D;const E=(D=g.actions)==null?void 0:D.find(r=>r.action==="SHIPPING_ADD"&&!r.return_id);if(E)return A(E.id)});await Promise.all(c),_&&await T({shipping_option_id:_},{onError:g=>{q.error(g.message)}})},z=I.useMemo(()=>M?!S.map(m=>{var g,E;const c=F.get(m.variant_id);return!(c!=null&&c.variant_id)||!(c!=null&&c.variant)||!((g=c.variant)!=null&&g.manage_inventory)?!0:(E=b[c.variant_id])==null?void 0:E.find(D=>D.location_id===M)}).every(Boolean):!1,[S,b,M]);return I.useEffect(()=>{(async()=>{const m={};if(!S.length)return m;const c=S.map(E=>E==null?void 0:E.variant_id).filter(Boolean);return(await Oe.admin.productVariant.list({id:c,fields:"*inventory.location_levels"})).variants.forEach(E=>{var D,r;m[E.id]=((r=(D=E.inventory)==null?void 0:D[0])==null?void 0:r.location_levels)||[]}),m})().then(m=>{P(m)})},[S]),e.jsxs("div",{children:[e.jsxs("div",{className:"mt-8 flex items-center justify-between",children:[e.jsx(pe,{level:"h2",children:i("orders.returns.outbound")}),e.jsxs(U,{id:"outbound-items",children:[e.jsx(U.Trigger,{asChild:!0,children:e.jsx("a",{className:"focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400",children:i("actions.addItems")})}),e.jsxs(U.Content,{children:[e.jsx(U.Header,{}),e.jsx(Ut,{selectedItems:S.map(_=>_.variant_id),currencyCode:t.currency_code,onSelectionChange:_=>{const m=S.map(c=>c.variant_id);ce=_.filter(c=>!m.includes(c)),ke=m.filter(c=>!_.includes(c))}}),e.jsx(U.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(X.Close,{asChild:!0,children:e.jsx(te,{type:"button",variant:"secondary",size:"small",children:i("actions.cancel")})}),e.jsx(te,{type:"submit",variant:"primary",size:"small",role:"button",onClick:async()=>await Z(),children:i("actions.save")},"submit-button")]})})})]})]})]}),W&&e.jsx(Me,{}),S.map((_,m)=>B.get(_.variant_id)&&e.jsx($t,{previewItem:B.get(_.variant_id),currencyCode:t.currency_code,form:o,onRemove:()=>{var g,E,D;const c=(D=(E=(g=N.find(r=>r.id===_.item_id))==null?void 0:g.actions)==null?void 0:E.find(r=>r.action==="ITEM_ADD"))==null?void 0:D.id;c&&j(c,{onError:r=>{q.error(r.message)}})},onUpdate:c=>{var E,D,r;const g=(r=(D=(E=N.find(u=>u.id===_.item_id))==null?void 0:E.actions)==null?void 0:D.find(u=>u.action==="ITEM_ADD"))==null?void 0:r.id;g&&R({...c,actionId:g},{onError:u=>{q.error(u.message)}})},index:m},_.id)),!W&&e.jsx("div",{className:"mt-8 flex flex-col gap-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(p.Label,{children:i("orders.exchanges.outboundShipping")}),e.jsx(p.Hint,{className:"!mt-1",children:i("orders.exchanges.outboundShippingHint")})]}),e.jsx(p.Field,{control:o.control,name:"outbound_option_id",render:({field:{value:_,onChange:m,...c}})=>e.jsx(p.Item,{children:e.jsx(p.Control,{children:e.jsx(ae,{allowClear:!0,noResultsPlaceholder:e.jsx(mt,{}),value:_??void 0,onChange:g=>{m(g),V(g)},...c,options:k.map(g=>({label:`${g.name} (${ct(g)})`,value:g.id})),disabled:!k.length})})})})]})}),z&&e.jsxs($e,{variant:"warning",dismissible:!0,className:"mt-4 p-5",children:[e.jsx("div",{className:"text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]",children:i("orders.returns.noInventoryLevel")}),e.jsx($,{className:"text-ui-fg-subtle txt-small leading-normal",children:i("orders.returns.noInventoryLevelDesc")})]})]})},ue=!1,Jt=({order:t,preview:n,exchange:a,orderReturn:o})=>{var C;const{t:i}=G(),{handleSuccess:x}=Tt(),[b,P]=I.useState(!1),[y,k]=I.useState(!1),[T,A]=I.useState({value:"0",float:0}),[H,R]=I.useState({value:"0",float:0}),{mutateAsync:j,isPending:N}=Ke(a.id,t.id),{mutateAsync:F,isPending:S}=We(a.id,t.id),{mutateAsync:L,isPending:Q}=Ze(a.id,t.id),{mutateAsync:w,isPending:B}=Ye(a.id,t.id),{mutateAsync:M}=yt((C=n==null?void 0:n.order_change)==null?void 0:C.id,{onError:s=>{q.error(s.message)}}),W=N||S||B||Q,Z=I.useMemo(()=>{var s;return(s=n==null?void 0:n.items)==null?void 0:s.filter(l=>{var d;return!!((d=l.actions)!=null&&d.find(v=>v.exchange_id===a.id))})},[n.items]),V=Z.filter(s=>{var l;return!!((l=s.actions)!=null&&l.find(d=>d.action==="RETURN_ITEM"))}),z=Z.filter(s=>{var l;return!!((l=s.actions)!=null&&l.find(d=>d.action==="ITEM_ADD"))}),_=I.useMemo(()=>t.promotions&&Array.isArray(t.promotions)&&t.promotions.length>0,[t]),m=vt({defaultValues:()=>{var d;const s=n.shipping_methods.find(v=>{var O;return!!((O=v.actions)!=null&&O.find(J=>J.action==="SHIPPING_ADD"&&!!J.return_id))}),l=n.shipping_methods.find(v=>{var O;return!!((O=v.actions)!=null&&O.find(J=>J.action==="SHIPPING_ADD"&&!J.return_id))});return Promise.resolve({inbound_items:V.map(v=>{var J,fe;const O=(J=v.actions)==null?void 0:J.find(Qe=>Qe.action==="RETURN_ITEM");return{item_id:v.id,variant_id:v.variant_id,quantity:v.detail.return_requested_quantity,note:O==null?void 0:O.internal_note,reason_id:(fe=O==null?void 0:O.details)==null?void 0:fe.reason_id}}),outbound_items:z.map(v=>({item_id:v.id,variant_id:v.variant_id,quantity:v.detail.quantity})),inbound_option_id:s?s.shipping_option_id:"",outbound_option_id:l?l.shipping_option_id:"",location_id:o==null?void 0:o.location_id,send_notification:!1,carry_over_promotions:((d=n==null?void 0:n.order_change)==null?void 0:d.carry_over_promotions)??!1})},resolver:It(Rt)}),c=n.shipping_methods.find(s=>{var l;return!!((l=s.actions)!=null&&l.find(d=>d.action==="SHIPPING_ADD"&&!!d.return_id))}),g=n.shipping_methods.find(s=>{var l;return!!((l=s.actions)!=null&&l.find(d=>d.action==="SHIPPING_ADD"&&!d.return_id))});I.useEffect(()=>{c&&A(c.total)},[c]),I.useEffect(()=>{g&&R(g.total)},[g]);const E=m.watch("inbound_option_id"),D=m.watch("outbound_option_id"),r=Nt(),u=m.handleSubmit(async s=>{try{if(!await r({title:i("general.areYouSure"),description:i("orders.exchanges.confirmText"),confirmText:i("actions.continue"),cancelText:i("actions.cancel"),variant:"confirmation"}))return;await j({no_notification:!s.send_notification}),x()}catch(l){q.error(i("general.error"),{description:l.message})}});I.useEffect(()=>{var s;b&&((s=document.getElementById("js-inbound-shipping-input"))==null||s.focus())},[b]),I.useEffect(()=>{var s;y&&((s=document.getElementById("js-outbound-shipping-input"))==null||s.focus())},[y]),I.useEffect(()=>()=>{ue&&(F(void 0,{onSuccess:()=>{q.success(i("orders.exchanges.actions.cancelExchange.successToast"))},onError:s=>{q.error(s.message)}}),ue=!1)},[]);const h=I.useMemo(()=>{const s=n.shipping_methods.find(l=>{var d;return!!((d=l.actions)!=null&&d.find(v=>v.action==="SHIPPING_ADD"&&!!v.return_id))});return(s==null?void 0:s.total)||0},[n.shipping_methods]),f=I.useMemo(()=>{const s=n.shipping_methods.find(l=>{var d;return!!((d=l.actions)!=null&&d.find(v=>v.action==="SHIPPING_ADD"&&!v.return_id))});return(s==null?void 0:s.total)||0},[n.shipping_methods]);return e.jsx(X.Form,{form:m,children:e.jsxs(At,{onSubmit:u,className:"flex h-full flex-col",children:[e.jsx(X.Header,{}),e.jsx(X.Body,{className:"flex size-full justify-center overflow-y-auto",children:e.jsxs("div",{className:"mt-16 w-[720px] max-w-[100%] px-4 md:p-0",children:[e.jsx(pe,{level:"h1",children:i("orders.exchanges.create")}),e.jsx(zt,{form:m,preview:n,order:t,exchange:a,orderReturn:o}),e.jsx(Qt,{form:m,preview:n,order:t,exchange:a}),e.jsxs("div",{className:"mt-8 border-y border-dotted py-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:i("orders.returns.inboundTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:ee(V.reduce((s,l)=>{var v;const d=(v=l.actions)==null?void 0:v.find(O=>O.action==="RETURN_ITEM");return s=s+((d==null?void 0:d.details.quantity)||0)/l.quantity*l.total,s},0)*-1,t.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:i("orders.exchanges.outboundTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:ee(z.reduce((s,l)=>(s=s+(l.total||0),s),0),t.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:i("orders.returns.inboundShipping")}),e.jsxs("span",{className:"txt-small text-ui-fg-subtle flex items-center",children:[!b&&e.jsx(ne,{onClick:()=>P(!0),variant:"transparent",className:"text-ui-fg-muted",disabled:!(V!=null&&V.length)||!E,children:e.jsx(ge,{})}),b?e.jsx(_e,{id:"js-inbound-shipping-input",onBlur:()=>{let s;n.shipping_methods.forEach(d=>{if(d.actions)for(const v of d.actions)v.action==="SHIPPING_ADD"&&v.return_id&&(s=v.id)});const l=T.float;s&&L({actionId:s,custom_amount:l},{onError:d=>{q.error(d.message)}}),P(!1)},symbol:Ne[t.currency_code.toUpperCase()].symbol_native,code:t.currency_code,onValueChange:(s,l,d)=>A({value:(d==null?void 0:d.value)??"",float:(d==null?void 0:d.float)??null}),value:T.value,disabled:!(V!=null&&V.length)}):ee(h,t.currency_code)]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:i("orders.exchanges.outboundShipping")}),e.jsxs("span",{className:"txt-small text-ui-fg-subtle flex items-center",children:[!y&&e.jsx(ne,{onClick:()=>k(!0),variant:"transparent",className:"text-ui-fg-muted",disabled:!(z!=null&&z.length)||!D,children:e.jsx(ge,{})}),y?e.jsx(_e,{id:"js-outbound-shipping-input",onBlur:()=>{let s;n.shipping_methods.forEach(d=>{if(d.actions)for(const v of d.actions)v.action==="SHIPPING_ADD"&&!v.return_id&&(s=v.id)});const l=H.float;s&&w({actionId:s,custom_amount:l},{onError:d=>{q.error(d.message)}}),k(!1)},symbol:Ne[t.currency_code.toUpperCase()].symbol_native,code:t.currency_code,onValueChange:(s,l,d)=>R({value:(d==null?void 0:d.value)??"",float:(d==null?void 0:d.float)??null}),value:H.value,disabled:!(z!=null&&z.length)}):ee(f,t.currency_code)]})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between border-t border-dotted pt-4",children:[e.jsx("span",{className:"txt-small font-medium",children:i("orders.exchanges.refundAmount")}),e.jsx("span",{className:"txt-small font-medium",children:ee(n.summary.pending_difference,t.currency_code)})]})]}),_&&e.jsx("div",{className:"bg-ui-bg-field mt-4 rounded-lg border py-2 pl-2 pr-4",children:e.jsx(p.Field,{control:m.control,name:"carry_over_promotions",render:({field:{onChange:s,value:l,...d}})=>e.jsxs(p.Item,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(p.Control,{className:"mr-4 self-start",children:e.jsx(be,{dir:"ltr",className:"mt-[2px] rtl:rotate-180",checked:!!l,onCheckedChange:async v=>{var O;s(v),(O=n==null?void 0:n.order_change)!=null&&O.id&&await M({carry_over_promotions:v})},...d})}),e.jsxs("div",{className:"block",children:[e.jsxs(p.Label,{className:"flex items-center gap-x-2",children:[i("orders.exchanges.carryOverPromotion"),e.jsx(p.Hint,{children:e.jsx(xe,{content:i("orders.exchanges.carryOverPromotionTooltip"),children:e.jsx(St,{})})})]}),e.jsx(p.Hint,{className:"!mt-1",children:i("orders.exchanges.carryOverPromotionHint")})]})]}),e.jsx(p.ErrorMessage,{})]})})}),e.jsx("div",{className:"bg-ui-bg-field mt-8 rounded-lg border py-2 pl-2 pr-4",children:e.jsx(p.Field,{control:m.control,name:"send_notification",render:({field:{onChange:s,value:l,...d}})=>e.jsxs(p.Item,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(p.Control,{className:"mr-4 self-start",children:e.jsx(be,{dir:"ltr",className:"mt-[2px] rtl:rotate-180",checked:!!l,onCheckedChange:s,...d})}),e.jsxs("div",{className:"block",children:[e.jsx(p.Label,{children:i("orders.returns.sendNotification")}),e.jsx(p.Hint,{className:"!mt-1",children:i("orders.returns.sendNotificationHint")})]})]}),e.jsx(p.ErrorMessage,{})]})})}),e.jsx("div",{className:"p-8"})]})}),e.jsx(X.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(X.Close,{asChild:!0,children:e.jsx(te,{type:"button",onClick:()=>ue=!0,variant:"secondary",size:"small",children:i("orders.exchanges.cancel.title")})}),e.jsx(te,{type:"submit",variant:"primary",size:"small",isLoading:W,children:i("orders.exchanges.confirm")},"submit-button")]})})})]})})},me=!1,vs=()=>{const{id:t}=gt(),n=_t(),{t:a}=G(),{order:o}=bt(t,{fields:pt}),{order:i}=jt(t),[x,b]=I.useState(),{mutateAsync:P}=Je(o.id),{exchange:y}=Xe(x,void 0,{enabled:!!x}),{return:k}=xt(y==null?void 0:y.return_id,void 0,{enabled:!!(y!=null&&y.return_id)});return I.useEffect(()=>{async function T(){if(!(me||!i)){if(i.order_change){i.order_change.change_type==="exchange"?b(i.order_change.exchange_id):(n(`/orders/${i.id}`,{replace:!0}),q.error(a("orders.exchanges.activeChangeError")));return}me=!0;try{const{exchange:A}=await P({order_id:i.id});b(A.id)}catch(A){q.error(A.message),n(`/orders/${i.id}`,{replace:!0})}finally{me=!1}}}T()},[i]),e.jsx(X,{children:y&&i&&o&&e.jsx(Jt,{order:o,exchange:y,preview:i,orderReturn:k})})};export{vs as Component};
