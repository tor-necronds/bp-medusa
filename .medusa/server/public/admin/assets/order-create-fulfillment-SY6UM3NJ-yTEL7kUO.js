import{g as $}from"./chunk-4XSXVVYD-4qtaglB2.js";import{g as C}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{u as K}from"./chunk-3TZOFKX2-Dm9sMIO-.js";import{C as X}from"./chunk-OFN7DIZA-CpT302SF.js";import{K as B}from"./chunk-6HTZNHPT-DGQV_Lcz.js";import{R as N,u as J}from"./chunk-AERWK3TJ-DmmmqBU-.js";import{ah as W,au as U,dd as Y,j as e,b as G,z as Z,dI as ee,dj as se,r as Q,aD as ie,aE as te,ax as ne,F as R,t as H,J as l,aw as S,aG as le,B as P,ay as ae,az as L,aH as re,aK as oe,s as ce,aB as de,al as ue,d6 as me,_ as fe,av as xe,a5 as z,K as pe}from"./index-DsV72Lgh.js";import{u as he}from"./chunk-HBXV7ENS-D2Tti13O.js";import{A as D}from"./alert-DxcP6O8k.js";var ge=ne({quantity:re(L(),oe()),location_id:L(),shipping_option_id:L().optional(),send_notification:ae().optional()});function je({item:t,form:m,locationId:a,reservations:h,disabled:_}){const{t:g}=G(),{variant:f}=de(t.product_id,t.variant_id,{fields:"*inventory,*inventory.location_levels,*inventory_items"},{enabled:!!t.variant}),{availableQuantity:v,inStockQuantity:y}=Q.useMemo(()=>{var s,r,c;if(!((s=f==null?void 0:f.inventory_items)!=null&&s.length)||!((r=f==null?void 0:f.inventory)!=null&&r.length)||!a)return{};const{inventory:o,inventory_items:p}=f;if(!o.every(i=>{var n;return(n=i.location_levels)==null?void 0:n.find(x=>x.location_id===a)}))return{};const T=new Map(p.map(i=>[i.inventory_item_id,i.required_quantity])),u=h==null?void 0:h.find(i=>i.line_item_id===t.id),A=(c=p.find(i=>i.inventory_item_id===(u==null?void 0:u.inventory_item_id)))==null?void 0:c.required_quantity,O=u?(u==null?void 0:u.quantity)/(A||1):0,q=o.map(i=>{var w;const n=(w=i.location_levels)==null?void 0:w.find(k=>k.location_id===a),x=T.get(i.id);if(!n||!x)return{availableQuantity:Number.MAX_SAFE_INTEGER,stockedQuantity:Number.MAX_SAFE_INTEGER};const j=n.available_quantity/x,M=n.stocked_quantity/x;return{availableQuantity:j,stockedQuantity:M}}),I=Math.min(...q.map(i=>i.availableQuantity)),F=Math.min(...q.map(i=>i.stockedQuantity));return I===Number.MAX_SAFE_INTEGER||F===Number.MAX_SAFE_INTEGER?{}:{availableQuantity:Math.floor(I+O),inStockQuantity:Math.floor(F)}},[f,a,h]),E=0,b=Math.min(C(t),v||Number.MAX_SAFE_INTEGER);return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl",children:e.jsxs("div",{className:"flex flex-row items-center",children:[_&&e.jsx("div",{className:"ml-4 inline-flex items-center",children:e.jsx(ue,{content:g("orders.fulfillment.disabledItemTooltip"),side:"top",children:e.jsx(me,{className:"text-ui-tag-orange-icon"})})}),e.jsxs("div",{className:fe("flex flex-1 flex-col gap-x-2 gap-y-2 border-b p-3 text-sm sm:flex-row",_&&"pointer-events-none opacity-50"),children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(xe,{src:t.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsx(z,{className:"txt-small",as:"span",weight:"plus",children:t.title}),t.variant_sku&&e.jsxs("span",{children:["(",t.variant_sku,")"]})]}),e.jsx(z,{as:"div",className:"text-ui-fg-subtle txt-small",children:t.variant_title})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"text-small flex flex-1 flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:g("orders.fulfillment.available")}),e.jsx("span",{className:"text-ui-fg-subtle",children:v||"N/A"})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:g("orders.fulfillment.inStock")}),e.jsxs("span",{className:"text-ui-fg-subtle",children:[y||"N/A"," ",y&&e.jsxs("span",{className:"font-medium text-red-500",children:["-",m.getValues(`quantity.${t.id}`)]})]})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-1",children:[e.jsx(l.Field,{control:m.control,name:`quantity.${t.id}`,rules:{required:!0,min:E,max:b},render:({field:o})=>e.jsxs(l.Item,{children:[e.jsx(l.Control,{children:e.jsx(pe,{className:"bg-ui-bg-base txt-small w-[50px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...o,onChange:p=>{const d=p.target.value===""?null:Number(p.target.value);o.onChange(d),isNaN(d)||(d<E||d>b?m.setError(`quantity.${t.id}`,{type:"manual",message:g("orders.fulfillment.error.wrongQuantity",{count:b,number:b})}):m.clearErrors(`quantity.${t.id}`))}})}),e.jsx(l.ErrorMessage,{})]})}),e.jsxs("span",{className:"text-ui-fg-subtle",children:["/ ",t.quantity," ",g("fields.qty")]})]})]})]})]})})}function ye({order:t,requiresShipping:m}){var I,F;const{t:a}=G(),{handleSuccess:h}=J(),_=Z(),{mutateAsync:g,isPending:f}=ee(t.id),{reservations:v}=se({line_item_id:t.items.map(s=>s.id),limit:$(t)}),y=K({queryFn:s=>ce.admin.stockLocation.list(s),queryKey:["stock_locations"],getOptions:s=>s.stock_locations.map(r=>({label:r.name,value:r.id}))}),[E,b]=Q.useState(()=>(t.items||[]).filter(s=>s.requires_shipping===m&&C(s)>0)),o=ie({defaultValues:{quantity:E.reduce((s,r)=>(s[r.id]=C(r),s),{}),send_notification:!t.no_notification},resolver:te(ge)}),p=R({name:"location_id",control:o.control}),{shipping_options:d=[],isLoading:T}=he({stock_location_id:p,fields:"+service_zone.fulfillment_set.location.id"}),u=R({name:"shipping_option_id",control:o.control}),A=o.handleSubmit(async s=>{const r=d.find(n=>n.id===u);if(!r){o.setError("shipping_option_id",{type:"manual",message:a("orders.fulfillment.error.noShippingOption")});return}if(!p){o.setError("location_id",{type:"manual",message:a("orders.fulfillment.error.noLocation")});return}let c=Object.entries(s.quantity).map(([n,x])=>({id:n,quantity:x})).filter(({quantity:n})=>!!n);if(m){const n=r==null?void 0:r.shipping_profile_id,x=t.items.reduce((j,M)=>{var w,k,V;return j[M.id]=(V=(k=(w=M.variant)==null?void 0:w.product)==null?void 0:k.shipping_profile)==null?void 0:V.id,j},{});c=c.filter(({id:j})=>x[j]===n)}const i={location_id:p,shipping_option_id:u,no_notification:!s.send_notification,items:c};try{await g(i),H.success(a("orders.fulfillment.toast.created")),h(`/orders/${t.id}`)}catch(n){H.error(n.message)}});Q.useEffect(()=>{var s,r;if(d!=null&&d.length){const c=(r=(s=t.shipping_methods)==null?void 0:s[0])==null?void 0:r.shipping_option_id;if(c){const i=d.find(n=>n.id===c);if(i){const n=i.service_zone.fulfillment_set.location.id;o.setValue("location_id",n),o.setValue("shipping_option_id",c||void 0)}}}},[d]);const O=(t.items||[]).map(s=>s.requires_shipping===m&&s.detail.fulfilled_quantity);Q.useEffect(()=>{var c;const s=((c=t==null?void 0:t.items)==null?void 0:c.filter(i=>i.requires_shipping===m&&C(i)>0))||[];b(s),s.length?o.clearErrors("root"):o.setError("root",{type:"manual",message:a("orders.fulfillment.error.noItems")});const r=s.reduce((i,n)=>(i[n.id]=C(n),i),{});o.setValue("quantity",r)},[...O,m]);const q=u&&((F=(I=t.shipping_methods)==null?void 0:I[0])==null?void 0:F.shipping_option_id)!==u;return e.jsx(N.Form,{form:o,children:e.jsxs(B,{onSubmit:A,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(N.Header,{}),e.jsx(N.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col divide-y divide-dashed",children:[e.jsx("div",{className:"pb-8",children:e.jsx(l.Field,{control:o.control,name:"location_id",render:({field:{...s}})=>e.jsxs(l.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-2 xl:flex-row xl:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(l.Label,{children:a("fields.location")}),e.jsx(l.Hint,{children:a("orders.fulfillment.locationDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(l.Control,{children:e.jsx(X,{...s,options:y.options,searchValue:y.searchValue,onSearchValueChange:y.onSearchValueChange,disabled:y.disabled})})})]}),e.jsx(l.ErrorMessage,{})]})})}),e.jsxs("div",{className:"py-8",children:[e.jsx(l.Field,{control:o.control,name:"shipping_option_id",render:({field:{onChange:s,ref:r,...c}})=>e.jsxs(l.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-2 xl:flex-row xl:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(l.Label,{children:a("fields.shippingMethod")}),e.jsx(l.Hint,{children:a("orders.fulfillment.methodDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(l.Control,{children:e.jsxs(S,{dir:_,onValueChange:s,...c,disabled:!p,children:[e.jsx(S.Trigger,{className:"bg-ui-bg-base",ref:r,children:T?e.jsxs("span",{className:"text-right",children:[a("labels.loading"),"..."]}):e.jsx(S.Value,{})}),e.jsx(S.Content,{children:d.map(i=>e.jsx(S.Item,{value:i.id,children:i.name},i.id))})]})})})]}),e.jsx(l.ErrorMessage,{})]})}),q&&e.jsxs(D,{className:"mt-4 p-4",variant:"warning",children:[e.jsx("span",{className:"-mt-[3px] block font-medium",children:a("labels.beaware")}),e.jsx("span",{className:"text-ui-fg-muted",children:a("orders.fulfillment.differentOptionSelected")})]})]}),e.jsxs("div",{children:[e.jsxs(l.Item,{className:"mt-8",children:[e.jsx(l.Label,{children:a("orders.fulfillment.itemsToFulfill")}),e.jsx(l.Hint,{children:a("orders.fulfillment.itemsToFulfillDesc")}),e.jsx("div",{className:"flex flex-col gap-y-1",children:E.map(s=>{var c,i,n,x;const r=((c=d.find(j=>j.id===u))==null?void 0:c.shipping_profile_id)===((x=(n=(i=s.variant)==null?void 0:i.product)==null?void 0:n.shipping_profile)==null?void 0:x.id);return e.jsx(je,{form:o,item:s,locationId:p,disabled:m&&!r,reservations:v},s.id)})})]}),o.formState.errors.root&&e.jsx(D,{variant:"error",dismissible:!1,className:"flex items-center",classNameInner:"flex justify-between flex-1 items-center",children:o.formState.errors.root.message})]}),e.jsx("div",{className:"mt-8 pt-8 ",children:e.jsx(l.Field,{control:o.control,name:"send_notification",render:({field:{onChange:s,value:r,...c}})=>e.jsxs(l.Item,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(l.Label,{children:a("orders.returns.sendNotification")}),e.jsx(l.Control,{children:e.jsx(l.Control,{children:e.jsx(le,{dir:"ltr",className:"rtl:rotate-180",checked:!!r,onCheckedChange:s,...c})})})]}),e.jsx(l.Hint,{className:"!mt-1",children:a("orders.fulfillment.sendNotificationHint")}),e.jsx(l.ErrorMessage,{})]})})})]})})})}),e.jsx(N.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(N.Close,{asChild:!0,children:e.jsx(P,{size:"small",variant:"secondary",children:a("actions.cancel")})}),e.jsx(P,{size:"small",type:"submit",isLoading:f,disabled:!u,children:a("orders.fulfillment.create")})]})})]})})}function Ce(){const{id:t}=W(),[m]=U(),a=m.get("requires_shipping")==="true",{order:h,isLoading:_,isError:g,error:f}=Y(t,{fields:"currency_code,*items,*items.variant,+items.variant.product.shipping_profile.id,*shipping_address,+shipping_methods.shipping_option_id"});if(g)throw f;const v=!_&&h;return e.jsx(N,{children:v&&e.jsx(ye,{order:h,requiresShipping:a})})}export{Ce as Component};
