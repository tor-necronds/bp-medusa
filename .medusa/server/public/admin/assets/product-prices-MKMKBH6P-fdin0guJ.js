import{D as H,c as W,a as K}from"./chunk-W7SLPIO2-D-JeoQt4.js";import{c as R}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as L}from"./chunk-6HTZNHPT-DGQV_Lcz.js";import{R as p,u as M}from"./chunk-AERWK3TJ-DmmmqBU-.js";import{ah as U,ag as k,j as e,b as V,b1 as q,x as $,r as z,aD as A,aE as I,ax as S,B as D,aI as J,aH as O,az as T,aK as Q,v as X,y as Y,F as Z}from"./index-DsV72Lgh.js";import"./chunk-DK4WIVY6-CYCbBMOO.js";var ee=({form:r})=>{const{store:t}=X(),{regions:a}=$({limit:9999}),{price_preferences:i}=Y({}),{setCloseOnEscape:s}=M(),n=re({currencies:t==null?void 0:t.supported_currencies,regions:a,pricePreferences:i}),o=Z({control:r.control,name:"variants"});return e.jsx(H,{columns:n,data:o,state:r,onEditingChange:j=>s(!j)})},se=W(),re=({currencies:r=[],regions:t=[],pricePreferences:a=[]})=>{const{t:i}=V();return z.useMemo(()=>[se.column({id:i("fields.title"),header:i("fields.title"),cell:s=>{const n=s.row.original;return e.jsx(H.ReadonlyCell,{context:s,children:e.jsx("div",{className:"flex h-full w-full items-center gap-x-2 overflow-hidden",children:e.jsx("span",{className:"truncate",children:n.title})})})},disableHiding:!0}),...K({currencies:r.map(s=>s.currency_code),regions:t,pricePreferences:a,getFieldName:(s,n)=>{var o;return(o=s.column.id)!=null&&o.startsWith("currency_prices")?`variants.${s.row.index}.prices.${n}`:`variants.${s.row.index}.prices.${n}`},t:i})],[i,r,t,a])},te=S({variants:J(S({prices:O(T(),T().or(Q()).optional()).optional()}))}),ae=({product:r,variantId:t})=>{var _;const{t:a}=V(),{handleSuccess:i}=M(),{mutateAsync:s,isPending:n}=q(r.id),{regions:o}=$({limit:9999}),j=z.useMemo(()=>o!=null&&o.length?o.reduce((l,d)=>(l[d.id]=d.currency_code,l),{}):{},[o]),c=t?(_=r.variants)==null?void 0:_.filter(l=>l.id===t):r.variants,g=A({defaultValues:{variants:c==null?void 0:c.map(l=>({title:l.title,prices:l.prices.reduce((d,u)=>{var m;return(m=u.rules)!=null&&m.region_id?d[u.rules.region_id]=u.amount:d[u.currency_code]=u.amount,d},{})}))},resolver:I(te,{})}),B=g.handleSubmit(async l=>{const d=l.variants.map((u,m)=>({id:c[m].id,prices:Object.entries(u.prices||{}).filter(([f,x])=>x!==""&&typeof x<"u").map(([f,x])=>{var P,w,F,C,E,N;const h=f.startsWith("reg_")?f:void 0,b=f.startsWith("reg_")?j[h]:f;let v;h?v=(F=(w=(P=c==null?void 0:c[m])==null?void 0:P.prices)==null?void 0:w.find(y=>y.rules.region_id===h))==null?void 0:F.id:v=(N=(E=(C=c==null?void 0:c[m])==null?void 0:C.prices)==null?void 0:E.find(y=>y.currency_code===b&&Object.keys(y.rules??{}).length===0))==null?void 0:N.id;const G=R(x);return{id:v,currency_code:b,amount:G,...h?{rules:{region_id:h}}:{}}})}));await s(d,{onSuccess:()=>{i("..")}})});return e.jsx(p.Form,{form:g,children:e.jsxs(L,{onSubmit:B,className:"flex size-full flex-col",children:[e.jsx(p.Header,{}),e.jsx(p.Body,{className:"flex flex-col overflow-hidden",children:e.jsx(ee,{form:g})}),e.jsx(p.Footer,{children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-x-2",children:[e.jsx(p.Close,{asChild:!0,children:e.jsx(D,{variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(D,{type:"submit",variant:"primary",size:"small",isLoading:n,children:a("actions.save")})]})})]})})},ue=()=>{const{id:r,variant_id:t}=U(),{product:a,isLoading:i,isError:s,error:n}=k(r);if(s)throw n;return e.jsx(p,{children:!i&&a&&e.jsx(ae,{product:a,variantId:t})})};export{ue as Component};
